// SPDX-License-Identifier: MIT

pragma solidity ^0.8.17;

import "forge-std/Test.sol";
import "../src/CellularEnergy.sol";

contract CellularEnergyTest is Test {
    address immutable owner = makeAddr("owner");
    address immutable player1 = vm.addr(0x2);
    address immutable player2 = vm.addr(0x3);
    address immutable player3 = vm.addr(0x4);
    address immutable verifierEOA = vm.addr(0x5);
    CellularEnergy game;
    Groth16Verifier verifier;

    function setUp() public {
        verifier = new Groth16Verifier();
        game = new CellularEnergy(owner, address(verifier));
        vm.deal(player1, 1 ether);
        vm.deal(player2, 1 ether);
        vm.deal(player3, 1 ether);
    }

    function mockCurrentBoard() internal pure returns (bytes16[64] memory board) {
        board[0] = bytes16(uint128(132922799578491587290380706028034457600));
    }

    function evolveCallData() internal pure returns (uint[2] memory _pA, uint[2][2] memory _pB, uint[2] memory _pC, uint[128] memory _pubSignals) {
        _pA[0] = 0x22ea04beb665bff79151f11515b09657a922b62bdd4f4b24d3c2a17a4144fb1b;
        _pA[1] = 0x1fe48d0df6b36d0f765674f0ac3661616687f80c02025c01532a916dacb9fc87;
        _pB[0][0] = 0x2a516e0cd217cde20dcccaadedd05ada8692278d5fee42cd2b8c7a221149e9ee;
        _pB[0][1] = 0x247177b687083d8b5e97982494b4f3f9d021c74a2f72b031436676d64c6dd2c3;
        _pB[1][0] = 0x2a765495aa94d750aad68248e12e870f26985a15dc641add5470d74292357fa5;
        _pB[1][1] = 0x0fb626bb194c3983a240672b6e299fdb9aebbdfa6d8ead8d63d501d889ff2e46;
        _pC[0] = 0x06efbdb961fc7bfde52e435067b4e390e91f11f545a01178a3f2ff9a0d5b7dff;
        _pC[1] = 0x2b3af335bb193c93d2b45a78a2ce9a4c247330b4f40086bab724de5d40329df3;
        _pubSignals[0] = 0x0000000000000000000000000000000064000000000000000000000000000000;
        _pubSignals[1] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[2] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[3] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[4] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[5] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[6] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[7] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[8] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[9] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[10] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[11] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[12] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[13] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[14] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[15] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[16] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[17] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[18] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[19] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[20] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[21] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[22] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[23] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[24] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[25] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[26] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[27] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[28] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[29] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[30] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[31] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[32] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[33] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[34] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[35] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[36] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[37] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[38] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[39] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[40] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[41] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[42] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[43] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[44] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[45] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[46] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[47] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[48] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[49] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[50] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[51] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[52] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[53] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[54] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[55] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[56] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[57] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[58] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[59] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[60] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[61] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[62] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[63] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[64] = 0x0000000000000000000000000000000020000000000000000000000000000000;
        _pubSignals[65] = 0x0000000000000000000000000000000010000000000000000000000000000000;
        _pubSignals[66] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[67] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[68] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[69] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[70] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[71] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[72] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[73] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[74] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[75] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[76] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[77] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[78] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[79] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[80] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[81] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[82] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[83] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[84] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[85] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[86] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[87] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[88] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[89] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[90] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[91] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[92] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[93] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[94] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[95] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[96] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[97] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[98] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[99] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[100] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[101] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[102] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[103] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[104] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[105] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[106] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[107] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[108] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[109] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[110] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[111] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[112] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[113] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[114] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[115] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[116] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[117] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[118] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[119] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[120] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[121] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[122] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[123] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[124] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[125] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[126] = 0x0000000000000000000000000000000000000000000000000000000000000000;
        _pubSignals[127] = 0x0000000000000000000000000000000000000000000000000000000000000000;
    }

    function mockNextBoard() internal pure returns (bytes16[64] memory board) {
        board[0] = bytes16(uint128(42535295865117307932921825928971026432));
        board[1] = bytes16(uint128(21267647932558653966460912964485513216));
    }

    function setFirstRound() internal {
        vm.prank(player1);
        game.joinTeam(1);
        vm.prank(player2);
        game.joinTeam(2);

        vm.prank(player1);
        game.injectCell{value: 1000000000000000}(0, 0);
        vm.prank(player1);
        game.injectCell{value: 1000000000000000}(0, 2);

        vm.prank(player2);
        game.injectCell{value: 1000000000000000}(0, 1);
    }

    function evolveBoard() internal {
        (uint[2] memory _pA, uint[2][2] memory _pB, uint[2] memory _pC, uint[128] memory _pubSignals) = evolveCallData();

        game.evolveBoardState(_pA, _pB, _pC, _pubSignals);
    }

    function test_constructor() external {
        assertEq(game.owner(), owner);
        assertEq(address(game.verifier()), address(verifier));
        assertEq(game.ROUND_LENGTH(), 15 minutes);
        assertEq(game.EPOCH_LENGTH(), 1 days);
        assertEq(game.SEASON_LENGTH(), 7 days);
        assertEq(game.MAX_EPOCHS_PER_SEASON(), 7);
        assertEq(game.MAX_ROUNDS_PER_EPOCH(), 96);
        assertEq(game.BASE_CELL_INJECTION_PRICE(), 1000000000000000);
        assertEq(game.MAINTENANCE_FEE_PERCENT(), 5);
        assertEq(game.TEAM_1(), 1);
        assertEq(game.TEAM_2(), 2);
        assertEq(game.round(), 1);
        assertEq(game.epoch(), 1);
        assertEq(game.season(), 1);
        assertEq(game.roundEnd(), block.timestamp + 15 minutes);
    }

    function testJoinTeam() external {
        vm.startPrank(player1);
        game.joinTeam(game.TEAM_1());

        assertEq(game.playerTeam(player1, game.season()), game.TEAM_1());
        vm.stopPrank();
    }

    function testJoinTeam_alreadyJoined() public {
        vm.prank(player1);
        game.joinTeam(1);
        assertEq(game.playerTeam(player1, 1), 1);

        vm.prank(player1);
        vm.expectRevert(CellularEnergy.AlreadyJoinedTeamForSeason.selector);
        game.joinTeam(2);
    }

    function testJoinTeam_InvalidTeam() public {
        vm.prank(player1);
        vm.expectRevert(CellularEnergy.InvalidTeam.selector);
        game.joinTeam(3);
    }

    function testInjectCell(uint8 team, uint8 x, uint8 y) public {
        vm.assume(team == game.TEAM_1() || team == game.TEAM_2());
        vm.assume(x < game.GRID_SIZE() && y < game.GRID_SIZE());
        uint256 price = 1000000000000000;
        uint256 maintenanceFee = (price * game.MAINTENANCE_FEE_PERCENT()) / 100;
        vm.prank(player1);
        game.joinTeam(team);
        vm.prank(player1);
        game.injectCell{value: 1000000000000000}(x, y);

        assertEq(team, game.getValueAtPosition(x, y));
        assertEq(game.playerContributions(player1, game.season()), price - maintenanceFee);
        assertEq(game.teamContributions(team, game.season()), price - maintenanceFee);
        assertEq(owner.balance, maintenanceFee);
    }

    function testInjectCell_OnlyPlayer() public {
        vm.prank(player1);
        vm.expectRevert(CellularEnergy.UnregisteredPlayer.selector);
        game.injectCell{value: 1000000000000000}(0, 0);
    }

    function testInjectCell_OnlyDuringLiveGame() public {
        vm.prank(player1);
        game.joinTeam(1);

        vm.warp(game.roundEnd());

        vm.prank(player1);
        vm.expectRevert(CellularEnergy.GameNotLive.selector);
        game.injectCell{value: 1000000000000000}(0, 0);
    }

    function testInjectCell_PositionOutOfRange() public {
        vm.prank(player1);

        game.joinTeam(1);
        vm.expectRevert(GameBoard.PositionOutOfRange.selector);
        vm.prank(player1);
        game.injectCell{value: 1000000000000000}(64, 64);
    }

    function testInjectCell_PositionOccupied() public {
        vm.prank(player1);
        game.joinTeam(1);
        vm.prank(player1);
        game.injectCell{value: 1000000000000000}(0, 0);
        vm.prank(player1);
        vm.expectRevert(GameBoard.PositionOccupied.selector);
        game.injectCell{value: 1000000000000000}(0, 0);
    }

    function testInjectCell_InsufficientFunds() public {
        vm.prank(player1);
        game.joinTeam(1);
        vm.prank(player1);
        vm.expectRevert(CellularEnergy.InsufficientFunds.selector);
        game.injectCell{value: 999999999999999}(0, 0);
    }

    function testClaimSeasonRewards() public {
        // Make sure the points get counted
        setFirstRound();
        vm.warp(game.roundEnd());
        evolveBoard();

        assertEq(game.teamScore(1, 1), 1);
        assertEq(game.teamScore(2, 1), 1);

        vm.prank(player1);
    }
}
